let countryTableData = [
  [
    "ארצות הברית",
    '<img src="./pics/square-full-solid.svg" alt=""/>',
    "4098",
    "46521",
    "1950",
    "45%",
  ],
  [
    "קרואטיה",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "10234",
    "37689",
    "1777",
    "33%",
  ],
  [
    "תאילנד",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "9489",
    "42013",
    "1324",
    "60%",
  ],
  [
    "מונטנגרו",
    '<img src="./pics/square-full-solid.svg" alt=""/>',
    "6112",
    "39254",
    "1678",
    "20%",
  ],
  [
    "רוסיה",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "10567",
    "50236",
    "1899",
    "50%",
  ],
  [
    "קפריסין",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "7045",
    "36345",
    "1209",
    "42%",
  ],
  [
    "ספרד",
    '<img src="./pics/square-full-solid.svg" alt=""/>',
    "4689",
    "41278",
    "1823",
    "41%",
  ],
  [
    "גיאורגיה",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "10567",
    "48009",
    "1355",
    "60%",
  ],
  [
    "צ'כיה",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "4112",
    "37901",
    "1602",
    "14%",
  ],
  [
    "מצרים",
    '<img src="./pics/square-full-solid.svg" alt=""/>',
    "6789",
    "45872",
    "1990",
    "32%",
  ],
  [
    "הולנד",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "10890",
    "40123",
    "1450",
    "16%",
  ],
  [
    "בולגריה",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "3701",
    "39245",
    "1176",
    "17%",
  ],
  [
    "יוון",
    '<img src="./pics/square-full-solid.svg" alt=""/>',
    "9634",
    "49783",
    "1689",
    "28%",
  ],
  [
    "טורקיה",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "11890",
    "36789",
    "1689",
    "31%",
  ],
  [
    "ברזיל",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "11456",
    "50345",
    "1132",
    "43%",
  ],
  [
    "גרמניה",
    '<img src="./pics/square-full-solid.svg" alt=""/>',
    "9423",
    "39321",
    "1901",
    "51%",
  ],
  [
    "איטליה",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "3923",
    "36128",
    "1500",
    "25%",
  ],
  [
    "סינגפור",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "11345",
    "50672",
    "1877",
    "21%",
  ],
  [
    "שוודיה",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "4778",
    "35901",
    "1762",
    "47%",
  ],
  [
    "קנדה",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "8189",
    "43876",
    "1443",
    "12%",
  ],
  [
    "צרפת",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "10987",
    "51123",
    "1999",
    "39%",
  ],
  [
    "אוסטרליה",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "10456",
    "41567",
    "1567",
    "28%",
  ],
  [
    "סין",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "6789",
    "48890",
    "1346",
    "34%",
  ],
  [
    "ניו זילנד",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "11678",
    "37234",
    "1698",
    "44%",
  ],
  [
    "הונג קונג",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "5809",
    "49567",
    "1698",
    "52%",
  ],
  [
    "אירלנד",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "3912",
    "36890",
    "1129",
    "22%",
  ],
  [
    "ניגריה",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "11654",
    "36789",
    "1980",
    "18%",
  ],
  [
    "קובה",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "7823",
    "50789",
    "1309",
    "16%",
  ],
  [
    "קפריסין",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "9987",
    "38567",
    "1765",
    "36%",
  ],
  [
    "סינגפור",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "4279",
    "41345",
    "1456",
    "45%",
  ],
  [
    "שוודיה",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "6098",
    "49567",
    "1888",
    "66%",
  ],
  [
    "איטליה",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "8756",
    "41678",
    "1098",
    "14%",
  ],
  [
    "סינגפור",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "6801",
    "49876",
    "1543",
    "27%",
  ],
  [
    "איחוד האמירויות",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "3978",
    "39123",
    "987",
    "26%",
  ],
  [
    "אוגנדה",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "11023",
    "48123",
    "1201",
    "54%",
  ],
  [
    "אורוגוואי",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "4321",
    "50456",
    "1654",
    "45%",
  ],
  [
    "איי סיישל",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "11890",
    "35901",
    "1423",
    "66%",
  ],
  [
    "אתיופיה",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "7546",
    "49456",
    "1890",
    "11%",
  ],
  [
    "בוליביה",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "3890",
    "37789",
    "1123",
    "42%",
  ],
  [
    "מלדיביים",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "11890",
    "40234",
    "1789",
    "32%",
  ],
  [
    "נמיביה",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "9256",
    "49890",
    "1234",
    "29%",
  ],
  [
    "נפאל",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "5654",
    "50789",
    "1989",
    "36%",
  ],
  [
    "פרגוואי",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "6890",
    "51234",
    "1564",
    "40%",
  ],
  [
    "צ'ילה",
    '<img src="./pics/square-full-solid1.svg" alt=""/>',
    "10234",
    "37234",
    "1078",
    "15%",
  ],
  [
    "קולומביה",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "4812",
    "51456",
    "1956",
    "34%",
  ],
  [
    "קוסטה ריקה",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "9145",
    "36789",
    "1345",
    "32%",
  ],

  [
    "תוניסיה",
    '<img src="./pics/square-full-solid2.svg" alt=""/>',
    "10678",
    "50890",
    "1821",
    "22%",
  ],
].map((row) => {
  const [
    country,
    color,
    landings,
    verifieds,
    verifiedsForeigners,
    landingsVerifieds,
  ] = row;
  let modifiedLandingsVerifieds = Math.max(
    parseFloat(landingsVerifieds.replace("%", "")),
    0
  );

  let modifiedLandings = Math.max(parseInt(landings) - Math.random() * 1500, 0);

  modifiedLandingsVerifieds -= Math.random() * 15;

  let modifiedverifieds = Math.max(
    parseInt(verifieds) - Math.random() * 10500,
    0
  );

  modifiedLandingsVerifieds -= Math.random() * 7;

  let modifiedlandingsVerifieds = Math.max(
    parseInt(landingsVerifieds) + Math.random() * 1500,
    0
  );

  modifiedLandingsVerifieds += Math.random() * 15;

  return [
    country,
    color,
    modifiedLandings.toFixed(0),
    modifiedverifieds.toFixed(0),
    modifiedlandingsVerifieds.toFixed(0),
    Math.floor(modifiedLandingsVerifieds) + "%",
  ];
});

const timeSpans = [
  ["חודש אחרון", 0.5],
  ["3 חודשים אחרונים", 1],
  ["6 חודשים אחרונים", 6],
  ["שנה אחרונה", 12],
  ["עד עכשיו", 18],
];

let timechoice = 0,
  dataNumber = 0;
const mapRank = (rank) => {
  if (rank < 4.5) return "#4DFF00";
  if (rank < 6) return "#E1FF00";
  if (rank < 7) return "#FF5900";
  return "red";
};
// Function to create the table
function createTable(tableData, tableBodyId) {
  const tableBody = document.getElementById(tableBodyId);
  tableBody.innerHTML = "";
  for (let i = 0; i < tableData.length; i++) {
    const row = document.createElement("tr");

    for (let j = 0; j < tableData[i].length; j++) {
      const cell = document.createElement("td");
      const span = document.createElement("span");
      if (tableBodyId === "tableBody2" && j == 1) {
        const color = mapRank(tableData[i][j]);
        span.style.backgroundColor = color;
        span.style.display = "inline-block";
        span.style.textAlign = "center";
        span.style.minWidth = "30px";
        span.style.textDecoration = "underline";
        span.style.textDecorationThickness = "1px";
      }
      // Add data from the array, including HTML content
      span.innerHTML = tableData[i][j];

      cell.appendChild(span);
      row.appendChild(cell);
    }

    tableBody.appendChild(row);
  }
}

// Call the function to create the table when the script is loaded
createTable(countryTableData, "tableBody1");

const country_select = document.getElementById("country-select");
const country_select_countries = document.querySelector(
  "#country-select .countries"
);
const country_search_input = document.getElementById("search-country");
const country_search_input_span = document.querySelector(
  "#search-country span"
);
const country_searchButton = document.querySelector(".search-button-2");
let countryClickCounts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
let countryNames = [];

for (let i = 0; i < countryTableData.length; i++) {
  countryNames.push(countryTableData[i][0]);
}
country_search_input.addEventListener("click", function () {
  createTimeSpanSelect(country_select_countries);
  country_select.classList.toggle("hide");
  country_searchButton.classList.toggle("search-button-clicked");
});

function resetCountryTable(render) {
  const allCheckboxes = document.querySelectorAll(
    "#country-select input[type=checkbox]"
  );
  if (render) {
    createTable(countryTableData, "tableBody1");
    country_search_input_span.innerHTML = `  3 חודשים אחורונים ,${countryDataOriginal.length}  מדינות נבחרו<img class="" src ="./pics/down-arrow.svg" width="20" height="20"/>`;
    allCheckboxes.forEach((checkbox) => {
      // add  only input that start in the same letter
      checkbox.checked = false;
    });
    selectedCountries = [];
  }

  if (selectedCountries.length === 0) {
    // change name of selectedCountries
    countryTableData = copyTable(countryDataOriginal);
    if (render) createTable(countryTableData, "tableBody1");
  }
}

function invokeCountryFilter() {
  // see how to filter the table by letter search
  if (selectedCountries.length === 0) return;

  countryTableData = countryDataOriginal.filter((row) =>
    selectedCountries.includes(row[0])
  );

  changeTimeValues(dataNumber, 1);

  countryTableData = countryDataOriginal.filter((row) => {
    return selectedCountries.includes(row[0]);
  });

  createTable(countryTableData, "tableBody1");
  changeTimeValues(1, dataNumber);
}

let selectedCountries = [];

function changeTimeValues(dataNumber, numerator) {
  let copyTable = countryTableData;

  for (let i = 0; i < copyTable.length; i++) {
    for (let j = 0; j < copyTable[i].length; j++) {
      if (j >= 2) {
        let cell = copyTable[i][j];
        if (cell.includes("%")) {
          copyTable[i][j] =
            ((
              (parseFloat(cell.replace("%", "")) * dataNumber) /
              numerator
            ).toFixed(0) %
              100) +
            "%";
        } else {
          copyTable[i][j] = (
            (parseFloat(cell) * dataNumber) /
            numerator
          ).toFixed(0);
        }
      }
    }
  }
}

function createTimeSpanSelect(list) {
  list.innerHTML = "";
  list.innerHTML += `
    <center>
    <input onclick="event.stopPropagation(); createCountriesSelect();" placeholder=" חיפוש מדינה..."/>
    </center/>
    <br/>
  `;
  for (let i = 0; i < timeSpans.length; i++) {
    // think what to change in the options
    let option = document.createElement("div");
    let checkbox = document.createElement("input");
    let span = document.createElement("span");

    option.addEventListener("click", function (e) {
      e.stopPropagation();
    });
    checkbox.addEventListener("click", function (e) {
      if (checkbox.checked) {
        dataFromTimeSpan(timeSpans[i][1]);
        timechoice = timeSpans[i][0];
        dataNumber = timeSpans[i][1];
      }
      e.stopPropagation();
    });
    option.classList.add("option-country");
    checkbox.type = "radio";
    checkbox.name = "timeSpan-country";
    checkbox.id = timeSpans[i][0];
    checkbox.value = timeSpans[i][1];

    if (i === 1) checkbox.checked = true;
    option.appendChild(checkbox);
    option.appendChild(span);
    span.textContent = timeSpans[i][0];
    list.appendChild(option);
  }
}

function createCountriesSelect() {
  country_select_countries.innerHTML = "";
  country_select_countries.innerHTML += `
  <center>
  <input onclick="event.stopPropagation(); " placeholder="חיפוש מדינה..."/>  
  </center/>
  <br/>
`;
  for (let i = 0; i < countryNames.length; i++) {
    let option = document.createElement("div");
    let checkbox = document.createElement("input");
    let span = document.createElement("span");

    option.addEventListener("click", function (e) {
      e.stopPropagation();
    });
    checkbox.addEventListener("click", function (e) {
      if (checkbox.checked) {
        selectedCountries.push(checkbox.value);
      } else {
        selectedCountries = selectedCountries.filter(
          (country) => country !== checkbox.value
        );
      }

      country_search_input_span.innerHTML =
        timechoice +
        `
    ,  ${selectedCountries.length} מדינות  
      <img class="" src ="./pics/down-arrow.svg" width="20" height="20"/>
    `;

      if (timechoice == 0) {
        country_search_input_span.innerHTML =
          "3 חודשים אחרונים" +
          `
    ,  ${selectedCountries.length} מדינות  
      <img class="" src ="./pics/down-arrow.svg" width="20" height="20"/>
    `;
      }
      // Stop the event from bubbling up to the parent
      e.stopPropagation();
    });
    option.classList.add("option-country");
    checkbox.type = "checkbox";
    checkbox.id = countryNames[i];
    checkbox.name = countryNames[i];
    checkbox.value = countryNames[i];
    option.appendChild(checkbox);
    option.appendChild(span);
    span.textContent = countryNames[i];
    country_select_countries.appendChild(option);
  }
}

const dataFromTimeSpan = (multiplier) => {
  if (!multiplier) countryTableData = copyTable(countryDataOriginal);
  else {
    countryTableData = copyTable(countryDataOriginal).map((row) => {
      return row.map((cell, index) => {
        let newCell = cell;
        if (index >= 2) {
          if (cell.includes("%"))
            newCell =
              ((parseFloat(cell.replace("%", "")) * multiplier).toFixed(0) %
                100) +
              "%";
          else newCell = (parseFloat(cell) * multiplier).toFixed(0);
        }
        return newCell;
      });
    });
  }
  createTable(countryTableData, "tableBody1");
};

const countryDataOriginal = copyTable(countryTableData);

function copyTable(table) {
  let newTable = [];
  for (var row in table) {
    newTable.push([...table[row]]);
  }
  return newTable;
}
const countryTableArrows = {
  0: document.querySelector("#table-arrow-countries-1"),
  1: document.querySelector("#table-arrow-countries-2"),
  2: document.querySelector("#table-arrow-countries-3"),
  3: document.querySelector("#table-arrow-countries-4"),
  4: document.querySelector("#table-arrow-countries-5"),
  5: document.querySelector("#table-arrow-countries-6"),
};

// Function to sort the table
function sortCountryTable(columnIndex) {
  const isNumber = columnIndex >= 2;
  if (countryClickCounts[columnIndex] === 0) {
    countryTableArrows[columnIndex].classList.remove("table-arrow-up");
    countryTableArrows[columnIndex].classList.remove("table-arrow");
    countryTableData.sort(function (a, b) {
      let textA = a[columnIndex];
      let textB = b[columnIndex];
      if (isNumber) {
        if (textA.includes("%")) textA = parseFloat(textA.replace("%", ""));
        else textA = parseFloat(textA);
        if (textB.includes("%")) textB = parseFloat(textB.replace("%", ""));
        else textB = parseFloat(textB);
        return textA - textB;
      }
      // Specify the locale as 'he' for Hebrew only for the specified column
      return textA.localeCompare(textB, "he", { sensitivity: "base" });
    });
  } else if (countryClickCounts[columnIndex] === 2) {
    countryTableArrows[columnIndex].classList.remove("table-arrow-up");
    countryTableArrows[columnIndex].classList.add("table-arrow");
    resetCountryTable();
  } else {
    countryTableArrows[columnIndex].classList.add("table-arrow-up");
    countryTableArrows[columnIndex].classList.remove("table-arrow");
    countryTableData.sort(function (a, b) {
      let textA = a[columnIndex];
      let textB = b[columnIndex];
      if (isNumber) {
        if (textA.includes("%")) textA = parseFloat(textA.replace("%", ""));
        else textA = parseFloat(textA);
        if (textB.includes("%")) textB = parseFloat(textB.replace("%", ""));
        else textB = parseFloat(textB);
        return textB - textA;
      }
      return textB.localeCompare(textA, "he", { sensitivity: "base" });
    });
  }
  countryClickCounts[columnIndex]++;
  countryClickCounts[columnIndex] %= 3;

  createTable(countryTableData, "tableBody1");
}
